@page "/"

@inject IDialogService DialogService
@inject NavigationManager Navigation

@using System.Text;

@using Leads.Model
@using frontend.Components

<PageTitle>Home</PageTitle>

<h1 class="fs-2">Bem-vindo(a) de volta!</h1>

<h2 class="mt-4 mb-5 fs-4">Lista de Leads Cadastrados</h2>

<div class="d-flex gap-x-5 mb-5">
    <MudTextField @bind-Value="_searchText"
              Placeholder="Pesquisar por Razão Social ou CNPJ"
              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Filled.Search"
              Class="mb-4"
              Immediate="true"
              OnKeyUp="@(e => ApplyFilter())" />

    <MudButton Class="m-1"
                EndIcon="@Icons.Material.Filled.Add"
                Variant="Variant.Filled"
                Color="Color.Primary"
                aria-label="cadastrar"
                OnClick="@(()=>Navigation.NavigateTo("/admin"))">
                Cadastrar
    </MudButton>
</div>


<MudTable Items="@FilteredLeads" HeaderClass="bg-dark" Hover="true" Striped="true" Bordered="true" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh Class="text-white fw-bold">CNPJ</MudTh>
        <MudTh Class="text-white fw-bold">Razão Social</MudTh>
        <MudTh Class="text-white fw-bold">CEP</MudTh>
        <MudTh Class="text-white fw-bold">Cidade</MudTh>
        <MudTh Class="text-white fw-bold">Estado</MudTh>
        <MudTh Class="text-white fw-bold">Ações</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="CNPJ">@context.Cnpj</MudTd>
        <MudTd DataLabel="Razão Social">@context.RazaoSocial</MudTd>
        <MudTd DataLabel="CEP">@context.Cep</MudTd>
        <MudTd DataLabel="Cidade">@context.Cidade</MudTd>
        <MudTd DataLabel="Estado">@context.Estado</MudTd>
        <MudTd DataLabel="Ações" Class="action-cell">
            <MudIconButton OnClick="@(() => OpenEditDialog(@context))" Class="m-1" Icon="@Icons.Material.Outlined.Edit" Variant="Variant.Outlined" Color="Color.Primary" aria-label="edit" />
            <MudIconButton OnClick="@(() => DeleteLead(@context.Cnpj))" Class="m-1" Icon="@Icons.Material.Outlined.Delete" Variant="Variant.Outlined" Color="Color.Secondary" aria-label="delete" />
        </MudTd>
    </RowTemplate>

    <NoRecordsContent>
        <MudText Color="Color.Secondary" Align="Align.Center">
            Sem dados cadastrados
        </MudText>
    </NoRecordsContent>
</MudTable>

@code { 
    private IList<Lead> Leads = new List<Lead>();
    private IList<Lead> FilteredLeads = new List<Lead>();

    private bool _loading = false;

    private string _searchText = string.Empty;

    private IDialogService? _dialog;

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(_searchText))
        {
            FilteredLeads = Leads.ToList();
        }
        else
        {
            FilteredLeads = Leads
                .Where(l =>
                    (!string.IsNullOrEmpty(l.RazaoSocial) && l.RazaoSocial.Contains(_searchText, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrEmpty(l.Cnpj) && l.Cnpj.Contains(_searchText, StringComparison.OrdinalIgnoreCase)))
                .ToList();
        }
    }


    public async Task DeleteLead(string cnpj)
    {
        HttpClient? client = new HttpClient();

        HttpRequestMessage? request = new HttpRequestMessage(HttpMethod.Delete, "http://localhost:5107/api/lead/delete")
        {
            Content = new StringContent($"\"{cnpj}\"", Encoding.UTF8, "application/json")
        };

        HttpResponseMessage? res = await client.SendAsync(request);

        if(res.IsSuccessStatusCode)
        {
            Lead? leadToRemove = Leads.FirstOrDefault(lead => lead.Cnpj == cnpj);
            Leads.Remove(leadToRemove);

            ApplyFilter();

            Console.WriteLine($"Lead {cnpj} successfully removed");
            StateHasChanged();
        }
    }

    public void OpenEditDialog(Lead leadData)
    {
        DialogParameters? parameters = new DialogParameters {[parameterName: "LeadData"] = leadData};
        
        DialogOptions? options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true
        };
        
        IDialogReference _dialog = DialogService.Show<EditLeadDialog>("Editar Lead", parameters, options);
    }

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        
        using HttpClient? client = new HttpClient();
        HttpResponseMessage? response = await client.GetAsync("http://localhost:5107/api/lead/get-all");

        if (response.IsSuccessStatusCode)
        {
            Leads = await response.Content.ReadFromJsonAsync<List<Lead>>();
        }
        else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            Console.WriteLine("Nenhum lead encontrado");
            Leads = new List<Lead>(); // garante lista vazia
        }
        else
        {
            // outros erros (500, 401, etc.)
            Console.WriteLine($"Erro ao buscar leads: {response.StatusCode}");
            Leads = new List<Lead>();
        }

        ApplyFilter();

        _loading = false;
    }
}